FROM jenkins/inbound-agent:latest
ARG NODE_VERSION=24.13.0
USER root

RUN apt-get update && apt-get install -y curl wget

RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash

ENV NVM_DIR=/root/.nvm
RUN bash -c "source ${NVM_DIR}/nvm.sh && nvm install ${NODE_VERSION}"

RUN bash -c "source ${NVM_DIR}/nvm.sh && corepack enable && corepack prepare pnpm@latest-10 --activate"

RUN cp -r /root/.nvm /home/jenkins/.nvm && \
    chown -R jenkins:jenkins /home/jenkins/.nvm

ENV NVM_DIR=/home/jenkins/.nvm
ENV PATH="${NVM_DIR}/versions/node/v${NODE_VERSION}/bin:$PATH"

ENTRYPOINT ["bash", "-c", "source ${NVM_DIR}/nvm.sh && exec \"$@\"", "--"]

CMD ["/bin/bash"]

USER jenkins